// Generated by CoffeeScript 1.12.6

/*
  2_core_contracts.coffee
  Created by Zefram Lou (Zebang Liu) as part of the WikiGit project.

  This file defines the deployment process of the core contracts of
  the DASP. In addition, it initializes the DASP's Git repo,
  publishes it onto the IPFS network, and saves its hash in the
  GitHandler module.
 */

(function() {
  var dao, fs, git, git_handler, ipfs, ipfsAPI, main, member_handler, tasks_handler, vault;

  main = artifacts.require('Main');

  dao = artifacts.require('Dao');

  member_handler = artifacts.require('MemberHandler');

  vault = artifacts.require('Vault');

  tasks_handler = artifacts.require('TasksHandler');

  git_handler = artifacts.require('GitHandler');

  ipfsAPI = require('ipfs-api');

  ipfs = ipfsAPI('ipfs.infura.io', '5001', {
    protocol: 'https'
  });

  git = require('gift');

  fs = require('fs');

  module.exports = function(deployer) {
    var abiPath;
    abiPath = './build/contracts';
    return ipfs.util.addFromFs(abiPath, {
      recursive: true
    }, function(error, abiAddrs) {
      if (error !== null) {
        throw error;
      }
      return deployer.deploy(main, 'Test Metadata').then(function() {
        var newHash, repoPath;
        repoPath = './tmp/repo.git';
        if (!fs.existsSync(repoPath)) {
          if (!fs.existsSync('./tmp')) {
            fs.mkdirSync('./tmp');
          }
          fs.mkdirSync(repoPath);
        }
        newHash = '';
        return git.init(repoPath, true, function(error, _repo) {
          if (error !== null) {
            throw error;
          }
          return ipfs.util.addFromFs(repoPath, {
            recursive: true
          }, function(error, result) {
            if (error !== null) {
              throw error;
            }
            console.log(error, result);
            newHash = result[result.length - 1].hash;
            return deployer.deploy([[dao, main.address], [member_handler, 'Test Username', main.address], [vault, main.address], [tasks_handler, main.address], [git_handler, newHash, main.address]]).then(function() {
              return main.deployed().then(function(instance) {
                return instance.initializeModuleAddresses([dao.address, member_handler.address, vault.address, tasks_handler.address, git_handler.address], 0);
              });
            }).then(function() {
              return dao.deployed().then(function(instance) {
                return instance.init();
              });
            });
          });
        });
      });
    });
  };

}).call(this);

//# sourceMappingURL=2_core_contracts.js.map
