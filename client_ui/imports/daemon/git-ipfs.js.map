{
  "version": 3,
  "file": "git-ipfs.js",
  "sourceRoot": "",
  "sources": [
    "git-ipfs.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "###\r\n  git-ipfs.coffee\r\n  Created by Zefram Lou (Zebang Liu) as part of the WikiGit project.\r\n\r\n  This file implements a daemon that listens for the TaskSolutionAccepted() event\r\n  from the GitHandler module. Upon such an event, the daemon would clone the\r\n  DASP's Git repo, pull from the updated repo where the task has been completed\r\n  to merge the solution into the DASP's repo, publish the resulting repo onto IPFS,\r\n  and send its IPFS multihash back to GitHandler as the current location of the DASP's repo.\r\n###\r\n\r\nimport {dasp} from '../ui/dasp_dashboard.js'\r\n\r\n#Import web3\r\nWeb3 = require 'web3'\r\nweb3 = window.web3\r\nif typeof web3 != undefined\r\n  web3 = new Web3(web3.currentProvider)\r\nelse\r\n  web3 = new Web3(new Web3.providers.HttpProvider(\"http://localhost:8545\"))\r\n\r\nweb3.eth.getAccounts().then(\r\n  (accounts) ->\r\n    web3.eth.defaultAccount = accounts[0]\r\n)\r\n\r\n#Import node modules\r\nipfsAPI = require 'ipfs-api'\r\nipfs = ipfsAPI('ipfs.infura.io', '5001', {protocol: 'https'})\r\ngit = require 'gift'\r\nfs = require 'fs'\r\nkeccak256 = require('js-sha3').keccak256\r\n\r\n#Helper functions\r\nhexToStr = (hex) ->\r\n  hex = hex.substr(2)\r\n  str = ''\r\n  for i in [0..hex.length - 1] by 2\r\n    str += String.fromCharCode(parseInt(hex.substr(i, 2), 16))\r\n  return str\r\n\r\nexport StartDaemon = () ->\r\n  #Fetch contract abstractions\r\n  tasksHandlerContract = dasp.contracts.tasks\r\n  gitHandlerContract = dasp.contracts.git\r\n\r\n  solutionAcceptedEvent = tasksHandlerContract.events.TaskSolutionAccepted()\r\n  solutionAcceptedEvent.on('data', (event) ->\r\n    patchIPFSHash = hexToStr event.returnValues.patchIPFSHash\r\n    gitHandlerContract.methods.getCurrentIPFSHash().call().then(\r\n      (result) ->\r\n        masterIPFSHash = hexToStr result\r\n        masterPath = \"./tmp/#{masterIPFSHash}/\"\r\n\r\n        #Create repo directory if it doesn't exist\r\n        if !fs.existsSync(masterPath)\r\n          if !fs.existsSync('./tmp')\r\n            fs.mkdirSync('./tmp')\r\n          fs.mkdirSync(masterPath)\r\n\r\n        #Clone the master\r\n        git.clone(\"git@gateway.ipfs.io/ipfs/\" + masterIPFSHash.toString(), masterPath, Number.POSITIVE_INFINITY, \"master\", (error, _repo) ->\r\n          if error != null\r\n            throw error\r\n          repo = _repo\r\n          #Add patched repo as remote\r\n          repo.remote_add(\"solution\", \"gateway.ipfs.io/ipfs/#{patchIPFSHash}\", (error) ->\r\n            if error != null\r\n              throw error\r\n            #Pull the patched repo and merge with the master\r\n            repo.pull(\"solution\", \"master\", (error) ->\r\n              if error != null\r\n                throw error\r\n              #Add new repo to the IPFS network\r\n              ipfs.util.addFromFs(masterPath, {recursive: true}, (error, result) ->\r\n                if error != null\r\n                  throw error\r\n                for entry in result\r\n                  if entry.path is masterIPFSHash\r\n                    gitHandlerContract.methods.commitTaskSolutionToRepo(\r\n                      event.returnValues.taskId,\r\n                      event.returnValues.solId,\r\n                      entry.hash\r\n                    ).send()\r\n                    break\r\n              )\r\n            )\r\n          )\r\n        )\r\n    )\r\n  )\r\n  return\r\n"
  ]
}